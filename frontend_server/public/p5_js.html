<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>p5.js testing</title>



    <script src="js/timer.js"></script>

    <style>
        .d-flex {
            display: flex;
            justify-content: center;
        }

        .listen {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;

            font-size: 20px;
            margin: 4px 0;
            cursor: pointer;
            width: 100vw;

            position: fixed;
            bottom: 1rem;
            left: 0;
        }

        #timer {
            font-size: 24px;
            text-align: center;
        }

        .matchStatus {
            text-align: center;
            color: #4caf50;
            font-size: 3rem;

            position: fixed;

            bottom: 6rem;
        }

        button {
            margin: 0.25rem;
        }
    </style>
</head>

<body>

    <div class="testing">testing</div>
    <div class="timer-container">
        <div id="timer">01:00:00</div>
    </div>

    <button id="stop" onclick="mic.stop()">stop</button>
    <button onclick="noLoop()">no loop</button>
    <button id="'play" onclick="playOscillator()">play the note</button>
    <button id="'stopPlaying" onclick="stopOscillator()">stop it</button>

    <div class="noteShown" style="color: #00ff70; background-color: #000000">
        random note: <span id="note"></span>
    </div>

    <button id="random">random</button>

    <div class="canvas-container"></div>

    <div class="text hz"></div>
    <div class="text notePlay"></div>

    <div class="d-flex">
        <div class="matchStatus">Ready</div>
    </div>
    <button class="listen" onclick="mic.start()">Sing it!</button>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"
        integrity="sha512-M7uzkKVt12bO/ClDOwaTk0AUwDPmJzjxri/KQKft2cisI6q3zJ4KxX3IfSQXF9Z6WU6NNW67JAljgWrA4WiiOA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.js"
        integrity="sha512-TU9AWtV5uUZPX8dbBAH8NQF1tSdigPRRT82vllAQ1Ke28puiqLA6ZVKxtUGlgrH6yWFnkKy+sE6luNEGH9ar0A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>


        // window.addEventListener('click', () => {
        //     setup()
        // })

        // window.addEventListener("load", () => {
        //     setup()
        // })

        // document.querySelector('#stop').addEventListener('click', () => {
        //     mic.stop();
        // })

        let mic, fft, osc, polySynth, gamePlaying;

        let randomMidi;
        let randomFreq;

        function setup() {
            let cup = createCanvas(40, 40);
            console.log(cup);

            // cup.parent(".canvas-container");
            // .parent(document.querySelector("#canvas")
            background(0);

            mic = new p5.AudioIn();

            fft = new p5.FFT();
            fft.setInput(mic, 1024);

            cup.touchStarted(playOscillator);
            cup.touchEnded(stopOscillator);

            osc = new p5.Oscillator("sine");
            polySynth = new p5.PolySynth();
        }

        function draw() {
            background(0);

            const dominantFreq = getDominantFrequency();

            const midi = freqToMidi(dominantFreq);

            const noteName = midiToNote(midi);

            const freq = midiToFreq(midi)

            const isMatched = matchFreq(dominantFreq, randomFreq);

            document.querySelector(".hz").innerText =
                "Dominant Frequency: " +
                (dominantFreq ? dominantFreq.toFixed(2) + " Hz" : "No signal");
            document.querySelector(".notePlay").innerText =
                "Note: " + (noteName ? noteName : "Unknown");


            if (gamePlaying) {
                console.log(isMatched);
                document.querySelector(".matchStatus").innerText = isMatched;

            }

            // fill("#00FF70");
            // textAlign(CENTER, CENTER);
            // textSize(18);
            // text('Dominant Frequency: ' + (dominantFreq ? dominantFreq.toFixed(2) + ' Hz' : 'No signal'), width / 2, height / 2 - 20);
            // text('Note: ' + (noteName ? noteName : 'Unknown'), width / 2, height / 2 + 20);
        }

        function getDominantFrequency() {
            const spectrum = fft.analyze(); // Get the frequency spectrum (Returns an array of amplitude values (between 0 and 255) across the frequency spectrum)
            // console.log('spectrum:', spectrum);

            // Find the index of the highest magnitude in the spectrum
            let maxIndex = 0;
            let maxValue = 0;
            for (let i = 0; i < spectrum.length; i++) {
                if (spectrum[i] > maxValue) {
                    maxValue = spectrum[i];
                    maxIndex = i;
                }
            }

            // Convert the index to a frequency value
            const dominantFreq = indexToFreq(
                maxIndex,
                getAudioContext().sampleRate,
                fft.bins
            );

            // console.log('#maxIndex:', maxIndex, 'sample rate:', getAudioContext().sampleRate, 'fftBins:', fft.bins)
            // console.log('FFT:', fft)

            return dominantFreq;
        }

        function freqToMidi(frequency) {
            return p5.prototype.freqToMidi(frequency);
        }

        function midiToNote(midiNote) {
            const notes = [
                "C",
                "C#",
                "D",
                "D#",
                "E",
                "F",
                "F#",
                "G",
                "G#",
                "A",
                "A#",
                "B",
            ];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;

            return notes[noteIndex] + octave;
        }

        function midiToFreq(midiNote) {
            return p5.prototype.midiToFreq(midiNote);
        }

        function indexToFreq(index, sampleRate, fftBins) {
            const binWidth = sampleRate / fftBins;

            // console.log('#bin width:', binWidth);
            console.log("*domFreq*:", (index * binWidth) / 2);

            return (index * binWidth) / 2;
        }

        function randomNote() {
            randomMidi = Math.floor(Math.random() * (84 - 48)) + 48;

            return midiToNote(randomMidi);
        }

        function playOscillator() {
            osc.start();

            console.log(gamePlaying);

            console.log("ready to call timer....");
            callTimer();

            gamePlaying = true;

            randomFreq = freq
            osc.freq(randomFreq, 0.1, 0.2);

        }

        function stopOscillator() {
            osc.stop();
        }

        document.querySelector("#random").addEventListener("click", () => {
            document.querySelector("#note").innerText = randomNote();
        });

        function matchFreq(dominantFreq, randomFreq) {
            try {
                const noteFrequencies = [
                    130.81, // C3
                    138.59, // C#3 
                    146.83, // D3
                    155.56, // D#3
                    164.81, // E3
                    174.61, // F3
                    185.0, // F#3
                    196.0, // G3
                    207.65, // G#3
                    220.0, // A3
                    233.08, // A#3
                    246.94, // B3
                    261.63, // C4
                    277.18, // C#4
                    293.66, // D4
                    311.13, // D#4
                    329.63, // E4
                    349.23, // F4
                    369.99, // F#4
                    392.0, // G4
                    415.3, // G#4
                    440.0, // A4
                    466.16, // A#4
                    493.88, // B4
                    523.25, // C5
                    554.37, // C#5
                    587.33, // D5
                    622.25, // D#5
                    659.26, // E5
                    698.46, // F5
                    739.99, // F#5
                    783.99, // G5
                    830.61, // G#5
                    880.0, // A5
                    932.33, // A#5
                    987.77, // B5
                    1046.5, // C6
                ];

                let bufferRange = 0.02;
                let thresholdRange = 0.05;

                for (let i = 0; i < noteFrequencies.length; i++) {
                    const lowerThresholdBound = noteFrequencies[i] * (1 - thresholdRange);
                    const upperThresholdBound = noteFrequencies[i] * (1 + thresholdRange);
                    // const lowerBufferBound = noteFrequencies[i] * (1 - bufferRange);
                    // const upperBufferBound = noteFrequencies[i] * (1 + bufferRange);

                    if (dominantFreq >= lowerThresholdBound && dominantFreq <= upperThresholdBound) {
                        const distance = Math.abs(dominantFreq - randomFreq);
                        if (distance <= bufferRange * randomFreq) {
                            return "Perfect !!";
                        } else {
                            return "Good try ~";
                        }
                    }
                    return "Poor...";
                }
            } catch (error) {
                console.error("An error occurred in matchFreq():", error);
                return "Error";

            }
        }

        // console.log("want to fit ~ noteFreq:", noteFrequencies[i],
        //                     '\n', "randomFreq:", randomFreq,
        //                     "\n", "range:", lowerBound + "to ",upperBound);


    </script>
</body>

</html>